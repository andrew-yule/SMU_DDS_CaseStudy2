---
title: "Predicting Employee Attrition"
subtitle: "An Analysis of Key Factors Leading to Employee Turnover"
author: "Andrew Yule"
format: html
editor_options: 
  chunk_output_type: console
---
## Introduction
The specific goals of this analysis are to:  

1.  Identify the top three factors that contribute to attrition  

2.  Learn about any job role specific trends that may exist in the data set (e.g., “Data Scientists have the highest job satisfaction”).  

3.  Provide any other interesting trends and observations from your analysis.  

4.  Build a model to predict attrition

## Executive Summary
To be filled in

## Libraries and Data Loading
```{r}
#| echo: true
#| output: false
#| warning: false
#| error: false
#| message: false
library(tidyverse)
library(gridExtra)
library(broom)
library(class)
library(caret)
library(e1071)

theme_set(theme_bw())
```

```{r}
#| echo: true
#| output: false
#| warning: false
#| error: false
#| message: false
employeeData = read_csv("https://raw.githubusercontent.com/ayule89/SMU_DDS_CaseStudy2/main/Data/CaseStudy2-data.csv")
```

## Identifying the top three factors that contribute to attrition

#### How many of the 870 employees in the data actually left?  
There were 140 out of 870 employees (16%) that left.
```{r}
#| echo: true
#| output: true
#| warning: false
#| error: false
#| message: false
employeeData |> count(Attrition)
```

### Screening all variables to visually investigate which parameters are the highest indicators of attrition  
There are a number of variables that could attribute to employee attrition. We will first visually screen each of the variables to look for potential leading indicators. The full list of variables includes: 

- Age  
- Business Travel  
- Daily Rate  
- Department  
- Distance From Home  
- Education  
- Education Field  
- Environment Satisfaction  
- Gender  
- Hourly Rate  
- Job Involvement  
- Job Level  
- Job Role  
- Job Satisfaction  
- Marital Status  
- Monthly Income  
- Monthly Rate  
- Number of Previous Companies Worked For  
- Over Time  
- Percent Salary Hike  
- Performance Rating  
- Relationship Satisfaction  
- Stock Options  
- Total Working Years  
- Training Times Last Year  
- Work Life Balance  
- Years At Company  
- Years In Current Role  
- Years Since Last Promotion  
- Years With Current Manager  

Before attrition across each variable, some of the numerical scales will need to put into various buckets. In order to determine appropriate buckets, we'll first plot histograms of the variables.
```{r}
#| echo: true
#| output: true
#| warning: false
#| error: false
#| message: false
employeeData |>
  select(Age, DailyRate, DistanceFromHome, HourlyRate, MonthlyIncome, MonthlyRate, TotalWorkingYears, YearsAtCompany, YearsInCurrentRole, YearsSinceLastPromotion, YearsWithCurrManager) |>
  pivot_longer(cols = everything(), names_to = "column", values_to = "value") |>
  ggplot(aes(x = value)) +
  geom_histogram() +
  facet_wrap(~column, scales = 'free', ncol = 3)
```

Based on visually inspecting the histograms, we'll use the following buckets for various numerical variables:

- Age (5 years)  
- Daily rate (400 dollars)  
- Distance from home (5 miles)  
- Hourly rate (20 dollars)  
- Monthly income (5,000 dollars)  
- Monthly rate (5,000 dollars)
- Total working years (5 years)  
- Years at company (5 years)  
- Years in current role (5 years)  
- Years since last promotion (5 years)  
- Years under current manager (5 years)

```{r}
#| echo: true
#| output: true
#| warning: false
#| error: false
#| message: false
employeeDataWithBuckets = employeeData |>
  mutate(
    Age = round(Age/5)*5, 
    DailyRate = round(DailyRate/400)*400,
    DistanceFromHome = round(DistanceFromHome/5)*5,
    HourlyRate = round(HourlyRate/20)*20,
    MonthlyIncome = round(MonthlyIncome/5000)*5000,
    MonthlyRate = round(MonthlyRate/5000)*5000,
    TotalWorkingYears = round(TotalWorkingYears/5)*5,
    YearsAtCompany = round(YearsAtCompany/5)*5,
    YearsInCurrentRole = round(YearsInCurrentRole/5)*5,
    YearsSinceLastPromotion = round(YearsSinceLastPromotion/5)*5,
    YearsWithCurrManager = round(YearsWithCurrManager/5)*5)
```

Now we'll go through and create plots of each variable showing the breakdown between attrition to visually look for any strong relationships
```{r}
#| echo: true
#| output: true
#| warning: false
#| error: false
#| message: false
#| fig-width: 12
#| fig-height: 15
findAttritionBreakdown = function(df, colName) {
  df |>
    group_by(!!sym(colName)) |>
    count(Attrition) |>
    ungroup() |>
    ggplot(aes(x = !!sym(colName), y = n, fill = Attrition)) +
    geom_col(position = "fill") +
    coord_cartesian(ylim = c(0, 0.55))
}
#findAttritionBreakdown(employeeDataWithBuckets, "DistanceFromHome")

cols = colnames(employeeData)
# Drop columns that we don't want to include in the analysis (ID, Attrition, EmployeeCount, EmployeeNumber, Over18, StandardHours) 
cols = cols[c(-1, -3, -10, -11, -23, -28)]

plots = map(cols, function(col) findAttritionBreakdown(employeeDataWithBuckets, col))
grid.arrange(grobs = plots, ncol = 3) ## display plots on one page
```

Based on examining the plots above, the following key variables were identified

- Age  
- BusinessTravel  
- DistanceFromHome  
- Education  
- EnvironmentSatisfaction  
- JobInvolvment  
- JobRole  
- JobSatisfaction  
- MaritalStatus  
- NumCompaniesWorked  
- OverTime  
- StockOptionLevel  
- TotalWorkingYears  
- WorkLifeBalance  
- YearsWithCurrManager  

In order to quantitatively determine the top 3 variables influencing attrition, we'll build a logistic regression model using the variables above. Before using the results of that regression to determine top variables influencing attrition, we'll first use cross validation to determine the type of accuracy that can be achieved using logistic regression.
```{r}
#| echo: true
#| output: true
#| warning: false
#| error: false
#| message: false

# Train a generalized linear model using a binomial family to perform logistic regression
set.seed(1234)
model = train(Attrition ~ Age + BusinessTravel + DistanceFromHome + DistanceFromHome + Education + EnvironmentSatisfaction + JobInvolvement + JobRole + JobSatisfaction + MaritalStatus + NumCompaniesWorked + OverTime + StockOptionLevel + TotalWorkingYears + WorkLifeBalance + YearsWithCurrManager, data = employeeData, method = "glm", family = "binomial", trControl = trainControl(method = "LOOCV"))

# Summarize the results to determine the possible accuracy
model
```

Using cross validation on our logistic regression, we can achieve an accuracy of over 88% which is high enough to warrant further use of the model to determine key variables influencing attrition.
```{r}
#| echo: true
#| output: true
#| warning: false
#| error: false
#| message: false
# Change Attrition (no/yes) into numerical values to work within the glm function
employeeDataForLogisticRegression = employeeData |>
  mutate(Attrition = ifelse(Attrition == "No", 0, 1))

# Fit the logistic regression model
model = glm(Attrition ~ Age + BusinessTravel + DistanceFromHome + DistanceFromHome + Education + EnvironmentSatisfaction + JobInvolvement + JobRole + JobSatisfaction + MaritalStatus + NumCompaniesWorked + OverTime + StockOptionLevel + TotalWorkingYears + WorkLifeBalance + YearsWithCurrManager, family = "binomial", data = employeeDataForLogisticRegression)

# Use the results of the model fitting along with the broom package which collects model metrics into data frames to quantitatively determine the top parameters
tidy(model) |>
  filter(p.value < 0.2) |>
  arrange(desc(abs(estimate)))
```

Based on the results from the logistic regression model, it looks the following variables are the top 3 when determining possible employee attrition:


1. X

